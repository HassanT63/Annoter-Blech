<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1c1c1e">
<title>Annoter Blech v25</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>

        body { 

            font-family: -apple-system, sans-serif; background: #000; color: white; margin: 0; 

            display: flex; flex-direction: column; height: 100vh; overflow: hidden;

        }

        /* En-t√™te compacte */

        .header-ui { background: #1c1c1e; padding: 5px; border-bottom: 1px solid #38383a; }

        /* Ligne 1 : Outils principaux */

        .row-tools { display: flex; gap: 4px; margin-bottom: 5px; }

        .row-tools button { 

            flex: 1; height: 42px; border-radius: 8px; border: none; 

            background: #3a3a3c; color: white; font-weight: bold; font-size: 11px;

        }

        button.active { background: #007aff !important; }

        /* Ligne 2 : R√©glages - On utilise flexbox pour que rien ne d√©borde */

        .settings-bar { 

            display: flex; align-items: center; gap: 6px; 

            background: #2c2c2e; padding: 6px; border-radius: 10px;

        }

        .color-wrapper { 

            width: 34px; height: 34px; border-radius: 50%; border: 2px solid #fff; 

            position: relative; overflow: hidden; flex-shrink: 0;

        }

        input[type="color"] { position: absolute; top: -10px; left: -10px; width: 60px; height: 60px; cursor: pointer; }

        select { 

            background: #3a3a3c; color: white; border: 1px solid #48484a; 

            height: 34px; border-radius: 6px; font-size: 11px; flex: 1; min-width: 0; 

        }

        input[type="range"] { flex: 0.6; accent-color: #007aff; min-width: 50px; }

        .btn-del { background: #ff3b30 !important; width: 34px; height: 34px; border-radius: 6px; border: none; flex-shrink: 0; font-size: 16px; }

        /* Bouton SAUVER forc√© √† droite et bien dimensionn√© */

        .btn-save { 

            background: #34c759 !important; color: white; height: 34px; border-radius: 6px; 

            border: none; font-weight: bold; font-size: 11px; padding: 0 8px; flex-shrink: 0;

        }

        .canvas-container { flex: 1; width: 100%; display: flex; justify-content: center; align-items: center; background: #000; position: relative; }

        canvas { touch-action: none; }

        #saveModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }

        #saveModal img { max-width: 90%; max-height: 70%; border: 2px solid white; border-radius: 10px; }
</style>
</head>
<body>
<div class="header-ui">
<div class="row-tools">
<button onclick="document.getElementById('upload').click()">üìÅ PHOTO</button>
<button id="btn-select" class="active" onclick="setMode('select')">üñ±Ô∏è BOUGER</button>
<button id="btn-arrow" onclick="setMode('arrow')">‚ÜóÔ∏è FL√àCHE</button>
<button id="btn-text" onclick="setMode('text')">A| TEXTE</button>
</div>
<div class="settings-bar">
<div class="color-wrapper"><input type="color" id="colorPicker" value="#ff3b30" oninput="updateSelectedStyle()"></div>
<select id="wordList" onchange="handleWordChange()">
<option value="">MOTS</option>
<option value="Chambre PB">Chambre PB</option>
<option value="Chambre interm√©diaire">Chambre interm√©diaire</option>
<option value="Regard client">Regard client</option>
<option value="Adduction">Adduction</option>
<option value="Maison client">Maison client</option>
<option value="PB">PB</option>
<option value="CUSTOM">‚ûï PERSO</option>
</select>
<input type="range" id="sizeMain" min="2" max="40" value="8" oninput="updateSelectedStyle()">
<button class="btn-del" onclick="deleteObj()">üóëÔ∏è</button>
<button class="btn-save" onclick="saveLogic()">üíæ SAUVER</button>
</div>
</div>
<div class="canvas-container" id="wrapper"><canvas id="c"></canvas></div>
<input type="file" id="upload" style="display:none" accept="image/*">
<div id="saveModal">
<p style="text-align:center">üì± <b>SAUVEGARDE IPHONE</b><br>Appui long sur l'image</p>
<img id="resultImage" src="">
<button style="margin-top:20px; padding:12px 25px; background:#555; color:white; border:none; border-radius:8px;" onclick="closeModal()">RETOUR</button>
</div>
<script>

    // Inscription du Service Worker pour le mode Hors-Ligne

    if ('serviceWorker' in navigator) {

        window.addEventListener('load', () => {

            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`

                const cacheName = 'blech-v25';

                self.addEventListener('install', e => {

                    e.waitUntil(caches.open(cacheName).then(cache => cache.addAll(['./', 'index.html', 'https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js'])));

                });

                self.addEventListener('fetch', e => {

                    e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));

                });

            `));

        });

    }

    let canvas = new fabric.Canvas('c', { stopPropagation: true, preserveObjectStacking: true });

    let mode = 'select', isDrawing = false, arrow, line, customText = "";

    function setMode(m) {

        mode = m;

        canvas.selection = (mode === 'select');

        canvas.forEachObject(obj => { obj.selectable = (mode === 'select'); obj.evented = (mode === 'select'); });

        document.querySelectorAll('.row-tools button').forEach(b => b.classList.remove('active'));

        if(document.getElementById('btn-'+m)) document.getElementById('btn-'+m).classList.add('active');

    }

    function handleWordChange() {

        let select = document.getElementById('wordList');

        if (select.value === "CUSTOM") {

            let userVal = prompt("Texte :");

            if (userVal) customText = userVal; else return;

        }

        let activeObj = canvas.getActiveObject();

        if (activeObj && activeObj.type === 'i-text') {

            activeObj.set({ text: select.value === "CUSTOM" ? customText : select.value });

            canvas.renderAll();

        } else { setMode('text'); }

    }

    function updateSelectedStyle() {

        let activeObjects = canvas.getActiveObjects();

        let color = document.getElementById('colorPicker').value;

        let thickness = parseInt(document.getElementById('sizeMain').value);

        activeObjects.forEach(obj => {

            if (obj.type === 'group') {

                obj.item(0).set({ stroke: color, strokeWidth: thickness });

                obj.item(1).set({ fill: color, width: thickness * 4, height: thickness * 4 });

                obj.set({ scaleX: 1, scaleY: 1 });

            } else if (obj.type === 'i-text') {

                obj.set({ fill: color, fontSize: thickness * 5 });

            }

        });

        canvas.renderAll();

    }

    document.getElementById('upload').onchange = function(e) {

        const reader = new FileReader();

        reader.onload = function(f) {

            fabric.Image.fromURL(f.target.result, function(img) {

                const wrapper = document.getElementById('wrapper');

                const ratio = Math.min(wrapper.clientWidth / img.width, wrapper.clientHeight / img.height);

                canvas.setDimensions({ width: img.width * ratio, height: img.height * ratio });

                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), { scaleX: ratio, scaleY: ratio });

            });

        };

        reader.readAsDataURL(e.target.files[0]);

    };

    canvas.on('mouse:down', function(o) {

        if (mode === 'select') return;

        isDrawing = true;

        let pointer = canvas.getPointer(o.e);

        let color = document.getElementById('colorPicker').value;

        let thickness = parseInt(document.getElementById('sizeMain').value);

        let wordToAdd = document.getElementById('wordList').value === "CUSTOM" ? customText : (document.getElementById('wordList').value || "TEXTE");

        if (mode === 'arrow') {

            line = new fabric.Line([pointer.x, pointer.y, pointer.x, pointer.y], { strokeWidth: thickness, stroke: color, selectable: false });

            arrow = new fabric.Triangle({ width: thickness * 4, height: thickness * 4, fill: color, left: pointer.x, top: pointer.y, originX: 'center', originY: 'center', angle: 90, selectable: false });

            canvas.add(line, arrow);

        } else if (mode === 'text') {

            let text = new fabric.IText(wordToAdd, { left: pointer.x, top: pointer.y, fill: color, fontSize: thickness * 5, fontWeight: 'bold' });

            canvas.add(text);

            setMode('select');

            isDrawing = false;

        }

    });

    canvas.on('mouse:move', function(o) {

        if (!isDrawing || mode !== 'arrow') return;

        let pointer = canvas.getPointer(o.e);

        line.set({ x2: pointer.x, y2: pointer.y });

        let angle = Math.atan2(pointer.y - line.y1, pointer.x - line.x1) * 180 / Math.PI;

        arrow.set({ left: pointer.x, top: pointer.y, angle: angle + 90 });

        canvas.renderAll();

    });

    canvas.on('mouse:up', function() {

        if (mode === 'arrow' && isDrawing) {

            let group = new fabric.Group([line, arrow], { selectable: true });

            canvas.remove(line, arrow);

            canvas.add(group);

            setMode('select');

        }

        isDrawing = false;

    });

    function deleteObj() {

        canvas.getActiveObjects().forEach(obj => canvas.remove(obj));

        canvas.discardActiveObject().renderAll();

    }

    function saveLogic() {

        canvas.discardActiveObject();

        canvas.renderAll();

        const dataURL = canvas.toDataURL({ format: 'png', quality: 1 });

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

        if (isIOS) {

            document.getElementById('resultImage').src = dataURL;

            document.getElementById('saveModal').style.display = 'flex';

        } else {

            const link = document.createElement('a');

            link.download = 'blech_' + new Date().getTime() + '.png';

            link.href = dataURL;

            link.click();

        }

    }

    function closeModal() { document.getElementById('saveModal').style.display = 'none'; }
</script>
</body>
</html>
 
